<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ channel.name }} - Menza</title>
    
    <!-- Theme initialization -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('menza-theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
            } else {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
            }
        })();
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.0/socket.io.min.js"></script>
    <link rel="stylesheet" href="/static/css/channel_view.css">
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="top-nav">
        <a href="/" class="nav-logo">
            <div class="nav-logo-icon">M</div>
            <span class="nav-logo-text">Menza</span>
        </a>
        <div class="nav-tabs">
            <a href="/chat" class="nav-tab">Messages</a>
            <a href="/channels" class="nav-tab active">Channels</a>
            <a href="/settings" class="nav-tab">Settings</a>
            <a href="/logout" class="nav-tab logout">Sign Out</a>
        </div>
    </nav>

    <div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="channel-nav">
                <span class="logo-text">Channels</span>
            </div>
            <div class="user-avatar">{{ username[0].upper() }}</div>
        </div>

        <div class="sidebar-actions">
            <a href="/channel/create" class="action-btn primary">
                âœ¨ Create
            </a>
            <a href="/channels" class="action-btn">
                ğŸ” Discover
            </a>
        </div>

        <div class="section-label">Your Channels</div>
        <div class="channel-list">
            {% for ch in my_channels %}
            <a href="/channel/{{ ch.id }}" class="channel-item {% if ch.id == channel.id %}active{% endif %}">
                <div class="channel-avatar" style="{% if ch.branding.avatar_type == 'image' and ch.branding.avatar_image %}background-image: url({{ ch.branding.avatar_image }});{% else %}background: {{ ch.branding.accent_color }}15; color: {{ ch.branding.accent_color }};{% endif %}">
                    {% if ch.branding.avatar_type != 'image' or not ch.branding.avatar_image %}{{ ch.branding.avatar_emoji }}{% endif %}
                </div>
                <div class="channel-info">
                    <div class="channel-name">{{ ch.name }}</div>
                    <div class="channel-meta">{{ ch.subscribers|length }} members</div>
                </div>
                <span class="channel-badge">Owner</span>
            </a>
            {% endfor %}
        </div>

        {% if subscribed_channels %}
        <div class="section-label">Subscribed</div>
        <div class="channel-list">
            {% for ch in subscribed_channels %}
            <a href="/channel/{{ ch.id }}" class="channel-item {% if ch.id == channel.id %}active{% endif %}">
                <div class="channel-avatar" style="{% if ch.branding.avatar_type == 'image' and ch.branding.avatar_image %}background-image: url({{ ch.branding.avatar_image }});{% else %}background: {{ ch.branding.accent_color }}15; color: {{ ch.branding.accent_color }};{% endif %}">
                    {% if ch.branding.avatar_type != 'image' or not ch.branding.avatar_image %}{{ ch.branding.avatar_emoji }}{% endif %}
                </div>
                <div class="channel-info">
                    <div class="channel-name">{{ ch.name }}</div>
                    <div class="channel-meta">{{ ch.subscribers|length }} members</div>
                </div>
            </a>
            {% endfor %}
        </div>
        {% endif %}

        <div class="sidebar-footer">
            <a href="/chat" class="footer-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>Back to Messages
            </a>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-area">
        <!-- Channel Header -->
        <div class="channel-header">
            <div class="header-avatar" style="{% if channel.branding.avatar_type == 'image' and channel.branding.avatar_image %}background-image: url({{ channel.branding.avatar_image }});{% endif %}">{% if channel.branding.avatar_type != 'image' or not channel.branding.avatar_image %}{{ channel.branding.avatar_emoji }}{% endif %}</div>
            <div class="header-info">
                <div class="header-name">{{ channel.name }}</div>
                <div class="header-stats">
                    <span>ğŸ‘¥ {{ channel.subscribers|length }} members</span>
                    <span>ğŸ“ {{ posts|length }} posts</span>
                    {% if can_manage %}
                    <span class="visibility-badge {% if channel.discoverable %}public{% else %}private{% endif %}">
                        {% if channel.discoverable %}ğŸŒŸ Public{% else %}ğŸ”’ Private{% endif %}
                    </span>
                    {% endif %}
                    {% if user_role %}
                    <span class="role-badge {{ user_role }}">
                        {% if is_owner %}ğŸ‘‘ Owner{% elif user_role == 'admin' %}ğŸ‘‘ Admin{% elif user_role == 'mod' %}âœï¸ Mod{% else %}ğŸ‘ï¸ Viewer{% endif %}
                    </span>
                    {% endif %}
                </div>
            </div>
            <div class="header-actions">
                {% if not is_subscribed and not is_owner %}
                <form action="/channel/{{ channel.id }}/subscribe" method="POST" style="display: inline;">
                    <button type="submit" class="header-btn primary">Join Channel</button>
                </form>
                {% elif is_subscribed and not is_owner %}
                <form action="/channel/{{ channel.id }}/unsubscribe" method="POST" style="display: inline;">
                    <button type="submit" class="header-btn subscribed">âœ“ Joined</button>
                </form>
                {% endif %}
                <button class="header-btn" onclick="toggleMembers()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Members</button>
                {% if can_manage %}
                <a href="/channel/{{ channel.id }}/settings" class="header-btn"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>Settings</a>
                {% endif %}
            </div>
        </div>

        <!-- Members Panel (Toggle) -->
        <div class="members-panel" id="membersPanel">
            <h3><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Members ({{ members_with_roles|length }})</h3>
            <div class="members-list">
                {% for member in members_with_roles %}
                <div class="member-item">
                    <div class="member-avatar">{{ member.username[0]|upper }}</div>
                    <div class="member-name">@{{ member.username }}</div>
                    {% if member.is_owner %}
                    <span class="role-badge admin">ğŸ‘‘ Owner</span>
                    {% elif member.role == 'admin' %}
                    <span class="role-badge admin">ğŸ‘‘ Admin</span>
                    {% elif member.role == 'mod' %}
                    <span class="role-badge mod">âœï¸ Mod</span>
                    {% else %}
                    <span class="role-badge viewer">ğŸ‘ï¸</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Posts -->
        <div class="posts-container">
            {% if posts %}
                {% for post in posts %}
                <div class="post" id="post-{{ post.id }}">
                    <div class="post-header">
                        <div class="post-avatar" style="{% if channel.branding.avatar_type == 'image' and channel.branding.avatar_image %}background-image: url({{ channel.branding.avatar_image }});{% endif %}">{% if channel.branding.avatar_type != 'image' or not channel.branding.avatar_image %}{{ channel.branding.avatar_emoji }}{% endif %}</div>
                        <div class="post-meta">
                            <div class="post-author">{{ post.author }}</div>
                            <div class="post-time">{{ post.timestamp[:16].replace('T', ' ') }}</div>
                        </div>
                    </div>
                    
                    {% if post.linked_post %}
                    <div class="linked-post">
                        <div class="linked-post-label">ğŸ”— Reply to post</div>
                    </div>
                    {% endif %}
                    
                    <div class="post-content" id="content-{{ post.id }}">{{ post.content }}</div>
                    
                    <div class="post-actions">
                        <button class="action-btn-post {% if username in post.likes %}liked{% endif %}" 
                                onclick="toggleLike('{{ post.id }}')" id="like-btn-{{ post.id }}">
                            â¤ï¸ <span id="like-count-{{ post.id }}">{{ post.likes|length }}</span>
                        </button>
                        
                        <div class="reactions-container" id="reactions-{{ post.id }}">
                            {% for emoji, users in post.reactions.items() %}
                            <button class="reaction-badge {% if username in users %}active{% endif %}" 
                                    onclick="addReaction('{{ post.id }}', '{{ emoji }}')">
                                {{ emoji }} <span class="reaction-count">{{ users|length }}</span>
                            </button>
                            {% endfor %}
                        </div>
                        
                        <div class="reaction-picker">
                            <button class="action-btn-post" onclick="toggleReactionPicker('{{ post.id }}')">
                                ğŸ˜€ React
                            </button>
                            <div class="reaction-dropdown" id="reaction-picker-{{ post.id }}">
                                {% for emoji in ['ğŸ‘', 'â¤ï¸', 'ğŸ”¥', 'ğŸ‘', 'ğŸ˜‚', 'ğŸ˜®', 'ğŸ˜¢', 'ğŸ‰', 'ğŸ’¯', 'ğŸš€', 'ğŸ’¡', 'â­'] %}
                                <span class="reaction-emoji" onclick="addReaction('{{ post.id }}', '{{ emoji }}')">{{ emoji }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <button class="action-btn-post" onclick="toggleComments('{{ post.id }}')">
                            ğŸ’¬ <span id="comment-count-{{ post.id }}">{{ post.comments|length }}</span>
                        </button>
                    </div>

                    <div class="comments-section">
                        <div class="comments-list" id="comments-{{ post.id }}">
                            {% for comment in post.comments %}
                            <div class="comment">
                                <div class="comment-avatar">{{ comment.author[0].upper() }}</div>
                                <div class="comment-content">
                                    <div class="comment-header">
                                        <span class="comment-author">{{ comment.author }}</span>
                                        <span class="comment-time">{{ comment.timestamp[:16].replace('T', ' ') }}</span>
                                    </div>
                                    <div class="comment-text">{{ comment.content }}</div>
                                </div>
                            </div>
                            {% endfor %}
                            <div class="comment-input-wrapper">
                                <input type="text" class="comment-input" placeholder="Write a comment..." 
                                       id="comment-input-{{ post.id }}" onkeypress="handleCommentKey(event, '{{ post.id }}')">
                                <button class="comment-submit" onclick="submitComment('{{ post.id }}')">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="empty-posts">
                <div class="empty-posts-icon">ğŸ“</div>
                <h3>No posts yet</h3>
                <p>{% if can_post %}Create your first post below!{% else %}Check back later for new content.{% endif %}</p>
            </div>
            {% endif %}
        </div>

    </div>
    </div> <!-- Close app-container -->
    
    <!-- Post Composer (Admins & Moderators Only) - Fixed at Bottom -->
    {% if can_post %}
    <div class="input-area">
        <!-- Calculator Preview - iOS Style -->
        <div class="calc-preview" id="calcPreview" style="position: absolute; bottom: 100%; left: 0; right: 0; margin-bottom: 0.5rem;">
            <div class="calc-suggestions" id="calcSuggestions">
                <!-- iOS-style suggestion chips will appear here -->
            </div>
        </div>

        <form action="/channel/{{ channel.id }}/post" method="POST">
            <div class="post-input-container">
                <div class="formatting-buttons">
                    <button type="button" class="format-btn" onclick="insertFormat('**', '**')" title="Bold">B</button>
                    <button type="button" class="format-btn" onclick="insertFormat('*', '*')" title="Italic" style="font-style: italic;">I</button>
                    <button type="button" class="format-btn" onclick="insertFormat('`', '`')" title="Code">&lt;&gt;</button>
                    <button type="button" class="format-btn" onclick="insertFormat('==', '==')" title="Highlight">ğŸ–ï¸</button>
                    <button type="button" class="format-btn" onclick="toggleLinkPost()" title="Link">ğŸ”—</button>
                </div>
                <textarea name="content" class="post-input" placeholder="Type a message..." required id="postContent" oninput="detectCalculations(this.value)" rows="1"></textarea>
                <select name="linked_post" style="display: none;" id="linkedPostSelect">
                    <option value="">No linked post</option>
                    {% for post in posts %}
                    <option value="{{ post.id }}">{{ post.content[:50] }}...</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="post-btn">Post</button>
        </form>
    </div>
    {% endif %}

    <script src="/static/js/channel_view.js"></script>
</body>
</html>
