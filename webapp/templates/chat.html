<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chat - Menza</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#7c3aed">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Menza">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Menza">
    <meta name="msapplication-TileColor" content="#7c3aed">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- PWA Manifest & Icons -->
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" type="image/svg+xml" href="/static/icons/icon-192.svg">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.svg">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Font Options for Preview -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.0/socket.io.min.js"></script>
    <link rel="stylesheet" href="/static/css/chat.css">
    <script>
        // Initialize theme from localStorage before page renders
        (function() {
            const savedTheme = localStorage.getItem('menza-theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
            } else {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
            }
        })();
    </script>
    
    <!-- Capacitor for iOS/Native -->
    <script src="https://unpkg.com/@capacitor/core@latest/dist/capacitor.js"></script>
    <script src="/static/js/native-bridge.js"></script>
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="top-nav">
        <a href="/" class="nav-logo">
            <span class="nav-logo-text">MENZA</span>
        </a>
        <div class="nav-tabs">
            <a href="/chat" class="nav-tab active">Messages</a>
            <a href="/channels" class="nav-tab">Channels</a>
            <a href="/bots" class="nav-tab">Bots</a>
            <a href="/settings" class="nav-tab">Settings</a>
            <a href="/logout" class="nav-tab logout">Sign Out</a>
        </div>
    </nav>

    <!-- App Container -->
    <div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <span class="sidebar-logo">MENZA</span>
            <div class="user-avatar" title="{{ username }}">{{ username[0].upper() }}</div>
        </div>

        <!-- Main Tab Buttons -->
        <div class="main-tabs">
            <button class="sidebar-btn active" id="chatsTabBtn" onclick="switchMainTab('chats')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                Chats
            </button>
            <button class="sidebar-btn" id="channelsTabBtn" onclick="switchMainTab('channels')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                My Channels
            </button>
        </div>

        <!-- Action Buttons Row -->
        <div class="action-row">
            <button class="sidebar-btn" data-panel="search" onclick="togglePanel('search', event)" title="Search">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="M21 21l-4.35-4.35"/>
                </svg>
                Search
            </button>
            <button class="sidebar-btn" data-panel="write" onclick="togglePanel('write', event)" title="Compose">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="14 2 18 6 7 17 3 17 3 13 14 2"/>
                    <line x1="3" y1="22" x2="21" y2="22"/>
                </svg>
                Write
            </button>
        </div>

        <!-- Write Panel (dropdown) -->
        <div class="write-panel-container" style="padding: 0 1rem;">
            <div class="dropdown-panel" id="writePanel">
                <button class="dropdown-item" onclick="startNewMessage()">
                    <div class="item-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                    </div>
                    <div class="item-info">
                        <div class="item-title">New Message</div>
                        <div class="item-desc">Start a private conversation</div>
                    </div>
                </button>
                <button class="dropdown-item" onclick="startNewGroup()">
                    <div class="item-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    </div>
                    <div class="item-info">
                        <div class="item-title">New Group</div>
                        <div class="item-desc">Create a group chat</div>
                    </div>
                </button>
                <a href="/channel/create" class="dropdown-item">
                    <div class="item-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                    </div>
                    <div class="item-info">
                        <div class="item-title">New Channel</div>
                        <div class="item-desc">Broadcast to subscribers</div>
                    </div>
                </a>
            </div>
        </div>

        <!-- Discover Row - Always Visible -->
        <div class="discover-row">
            <a href="/channels" class="sidebar-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/>
                </svg>
                Discover Channels
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18l6-6-6-6"/>
                </svg>
            </a>
            <a href="/bots" class="sidebar-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="10" rx="2"/>
                    <circle cx="12" cy="5" r="2"/>
                    <path d="M12 7v4"/>
                    <circle cx="8" cy="16" r="1"/>
                    <circle cx="16" cy="16" r="1"/>
                </svg>
                Bot Store
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18l6-6-6-6"/>
                </svg>
            </a>
        </div>

        <!-- CHATS TAB CONTENT -->
        <div class="tab-content active" id="chatsTabContent">
            <!-- Messages Section (Groups + Direct Messages combined) -->
            <div class="contacts-section">
                <div class="section-label">Messages</div>
            </div>

            <div class="contacts" id="messagesList">
                <!-- Active conversations will be populated by JavaScript -->
                <div class="empty-messages" id="emptyMessagesState" style="text-align: center; padding: 2rem 1rem; color: var(--text-muted);">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.4; margin-bottom: 0.75rem;">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    <p style="font-size: 0.9375rem; font-weight: 500;">No messages yet</p>
                    <p style="font-size: 0.8125rem; margin-top: 0.25rem;">Start a conversation using the Write button</p>
                </div>
            </div>
            
            <!-- To start a new chat, use Write ‚Üí New Message -->
        </div>

        <!-- CHANNELS TAB CONTENT -->
        <div class="tab-content" id="channelsTabContent">
            <div class="channels-panel">
                <!-- My Channels -->
                <div class="channel-section-title">My Channels</div>
                <div class="my-channels-list">
                    {% if my_channels %}
                        {% for channel in my_channels %}
                        <a href="/channel/{{ channel.id }}" class="channel-item">
                            <div class="channel-item-avatar" style="background: {{ channel.branding.accent_color }}20; color: {{ channel.branding.accent_color }};">
                                {{ channel.branding.avatar_emoji }}
                            </div>
                            <div class="channel-item-info">
                                <div class="channel-item-name">{{ channel.name }}</div>
                                <div class="channel-item-meta">{{ channel.subscribers|length }} members</div>
                            </div>
                        </a>
                        {% endfor %}
                    {% else %}
                        <div class="empty-channels">
                            No channels yet.<br>
                            <a href="/channels">Discover channels</a> or <a href="/channel/create">create one</a>
                        </div>
                    {% endif %}
                </div>

                <!-- Create Channel Link -->
                <div class="channel-action-btn">
                    <a href="/channel/create" class="sidebar-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="16"/>
                            <line x1="8" y1="12" x2="16" y2="12"/>
                        </svg>
                        Create Channel
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 18l6-6-6-6"/>
                        </svg>
                    </a>
                </div>
            </div>
        </div>

        <div class="sidebar-footer">
            <a href="/logout" class="nav-btn logout-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/>
                </svg>
                Sign Out
            </a>
        </div>
    </div>

    <!-- Chat Area -->
    <div class="chat-area">
        <!-- Empty State (No chat selected) -->
        <div class="empty-state" id="empty-state">
            <div class="empty-icon">üí¨</div>
            <h2>Your Messages</h2>
            <p>Select a conversation from the sidebar to start messaging securely.</p>
        </div>

        <!-- Active Chat (hidden by default) -->
        <div id="active-chat">
            <div class="chat-header">
                <div class="chat-header-avatar" id="chat-avatar">?</div>
                <div class="chat-header-info">
                    <h2 id="chat-username">Username</h2>
                    <p id="chat-status">
                        <span class="online-dot" id="chat-status-dot" style="display: none;"></span>
                        <span id="chat-status-text">Offline</span>
                    </p>
                </div>
                <!-- Call Buttons -->
                <div class="call-buttons">
                    <button class="call-btn voice-call-btn" onclick="startCall(false)" title="Voice Call">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/>
                        </svg>
                    </button>
                    <button class="call-btn video-call-btn" onclick="startCall(true)" title="Video Call">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="23 7 16 12 23 17 23 7"/>
                            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                        </svg>
                    </button>
                </div>
                <div class="encryption-badge">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0110 0v4"/>
                    </svg>
                    End-to-End Encrypted
                </div>
                <button class="shared-notes-btn" id="sharedNotesBtn" onclick="toggleSharedNotes()" title="Shared Notes">
                    üìù
                    <span class="notes-badge" id="notesBadge" style="display: none;"></span>
                </button>
                <button class="chat-settings-btn" onclick="openChatSettings()" title="Chat Settings">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
                    </svg>
                </button>
            </div>

            <!-- Shared Notes Panel -->
            <div class="shared-notes-container" id="sharedNotesPanel" style="display: none;">
                <div class="shared-notes-header">
                    <div class="shared-notes-title">
                        üìù Shared Notes
                        <span style="font-size: 0.6875rem; color: var(--text-muted); font-weight: 400;">(Secured with personal phrases)</span>
                    </div>
                    <button class="add-note-btn" onclick="openCreateNoteModal()">+ Add Note</button>
                </div>
                <div class="shared-notes-list" id="sharedNotesList">
                    <div class="empty-notes">No shared notes yet. Create one to securely share with this conversation.</div>
                </div>
            </div>

            <div class="messages-container" id="messages">
                <!-- Messages will be inserted here -->
            </div>

            <div class="input-area">
                <!-- Calculator Preview - iOS Style -->
                <div class="calc-preview" id="calcPreview">
                    <div class="calc-suggestions" id="calcSuggestions">
                        <!-- iOS-style suggestion chips will appear here -->
                    </div>
                </div>

                <div class="message-input-container">
                    <textarea 
                        class="message-input" 
                        id="message-input" 
                        placeholder="Type a message..." 
                        rows="1"
                        onkeydown="handleKeyDown(event)"
                        oninput="autoResize(this); detectCalculations(this.value)"
                    ></textarea>
                </div>
                <button class="send-btn" onclick="sendMessage()" id="send-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13M22 2L15 22L11 13L2 9L22 2Z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    </div> <!-- Close app-container -->

    <!-- New Message Modal -->
    <div class="modal-overlay" id="newMessageModal">
        <div class="modal" style="max-width: 480px;">
            <div class="modal-header">
                <h3>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    New Message
                </h3>
                <button class="modal-close" onclick="closeModal('newMessageModal')">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Selected Recipients Preview -->
                <div id="selectedRecipientsPreview" class="selected-members-preview" style="display: none; margin-bottom: 1rem;">
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">To: <span id="selectedRecipientsCount">0</span> recipient(s)</p>
                    <div id="selectedRecipientsList" class="selected-members-list" style="display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
                </div>
                
                <!-- Search Input (always visible) -->
                <div style="margin-bottom: 1rem;">
                    <input type="text" class="modal-input" placeholder="Search users..." id="newMessageSearchInput" oninput="searchUsersForMessage(this.value)" style="margin-bottom: 0;">
                    <p style="font-size: 0.6875rem; color: var(--text-muted); margin-top: 0.5rem;">
                        üí° Select one user for DM, or multiple users to create a group
                    </p>
                </div>
                
                <!-- User List -->
                <div class="user-select-list" id="messageUserList" style="max-height: 300px; overflow-y: auto;">
                    <div class="loading-placeholder" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                        <div class="spinner" style="width: 24px; height: 24px; border: 2px solid var(--border); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 0.5rem;"></div>
                        Loading...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('newMessageModal')">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="startConversationBtn" onclick="startConversation()" disabled>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    <span id="startConversationBtnText">Select Recipients</span>
                </button>
            </div>
        </div>
    </div>

    <!-- New Group Modal -->
    <div class="modal-overlay" id="newGroupModal">
        <div class="modal" style="max-width: 520px;">
            <div class="modal-header">
                <h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Create Group</h3>
                <button class="modal-close" onclick="closeModal('newGroupModal')">√ó</button>
            </div>
            <div class="modal-body">
                <input type="text" class="modal-input" placeholder="Group name..." id="groupName" style="margin-bottom: 1rem;">
                
                <!-- Selected Members Preview -->
                <div id="selectedMembersPreview" class="selected-members-preview" style="display: none;">
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">Selected members:</p>
                    <div id="selectedMembersList" class="selected-members-list"></div>
                </div>
                
                <!-- Tabs for adding members -->
                <div class="group-tabs">
                    <button class="group-tab active" onclick="switchGroupTab('contacts')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        Contacts
                    </button>
                    <button class="group-tab" onclick="switchGroupTab('search')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                        Search
                    </button>
                    <button class="group-tab" onclick="switchGroupTab('invite')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                        Invite Link
                    </button>
                </div>
                
                <!-- Contacts Tab -->
                <div id="groupContactsTab" class="group-tab-content active">
                    <p style="font-size: 0.8125rem; color: var(--text-muted); margin-bottom: 0.75rem;">Select from your contacts:</p>
                    <div class="user-select-list" id="groupUserList">
                        {% for user in all_users %}
                        <div class="user-select-item" data-username="{{ user }}" onclick="toggleGroupMember(this, '{{ user }}')">
                            <div class="user-select-avatar">{{ user[0].upper() }}</div>
                            <div class="user-select-name">{{ user }}</div>
                            <div class="user-select-check">‚úì</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Search Tab -->
                <div id="groupSearchTab" class="group-tab-content">
                    <p style="font-size: 0.8125rem; color: var(--text-muted); margin-bottom: 0.75rem;">Search by username:</p>
                    <input type="text" class="modal-input" placeholder="Enter username..." id="groupSearchInput" oninput="searchUsersForGroup(this.value)" style="margin-bottom: 0.75rem;">
                    <div class="user-select-list" id="groupSearchResults">
                        <div class="search-placeholder">
                            <span style="font-size: 1.5rem; opacity: 0.5;">üîç</span>
                            <p style="color: var(--text-muted); font-size: 0.8125rem;">Type a username to search</p>
                        </div>
                    </div>
                </div>
                
                <!-- Invite Link Tab -->
                <div id="groupInviteTab" class="group-tab-content">
                    <div class="invite-link-section">
                        <div class="invite-link-icon">üîó</div>
                        <h4 style="margin-bottom: 0.5rem;">Invite via Link</h4>
                        <p style="font-size: 0.8125rem; color: var(--text-muted); margin-bottom: 1rem;">
                            Generate an invite link that anyone can use to join your group.
                        </p>
                        <div class="invite-link-box" id="groupInviteLinkBox" style="display: none;">
                            <input type="text" class="modal-input" id="groupInviteLink" readonly style="font-family: monospace; font-size: 0.75rem;">
                            <button class="invite-copy-btn" onclick="copyGroupInviteLink()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> Copy</button>
                        </div>
                        <button class="generate-link-btn" id="generateGroupLinkBtn" onclick="generateGroupInviteLink()">
                            ‚ú® Generate Invite Link
                        </button>
                        <p style="font-size: 0.6875rem; color: var(--text-muted); margin-top: 0.75rem;">
                            ‚ö†Ô∏è Anyone with this link can join. You can revoke it anytime.
                        </p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('newGroupModal')">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="createGroup()">Create Group</button>
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div class="modal-overlay" id="searchModal">
        <div class="modal search-modal">
            <div class="modal-header">
                <h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>Search</h3>
                <button class="modal-close" onclick="closeModal('searchModal')">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Search Input -->
                <div class="search-input-container">
                    <svg class="search-input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="M21 21l-4.35-4.35"/>
                    </svg>
                    <input type="text" 
                           class="search-modal-input" 
                           placeholder="Search users, groups, channels, contacts..." 
                           id="globalSearchInput"
                           oninput="handleGlobalSearch(this.value)"
                           autocomplete="off">
                </div>

                <!-- Search Category Tabs -->
                <div class="search-category-tabs">
                    <button class="search-cat-tab active" data-category="all" onclick="setSearchCategory('all')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                        All
                    </button>
                    <button class="search-cat-tab" data-category="users" onclick="setSearchCategory('users')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        Users
                    </button>
                    <button class="search-cat-tab" data-category="groups" onclick="setSearchCategory('groups')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        Groups
                    </button>
                    <button class="search-cat-tab" data-category="channels" onclick="setSearchCategory('channels')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                        Channels
                    </button>
                    <button class="search-cat-tab" data-category="contacts" onclick="setSearchCategory('contacts')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                        Contacts
                    </button>
                </div>

                <!-- Search Results -->
                <div class="search-results-container" id="searchResultsContainer">
                    <div class="search-placeholder">
                        <div class="search-placeholder-icon">üîç</div>
                        <p>Start typing to search...</p>
                        <span class="search-placeholder-hint">Search for users, groups, channels, or synced contacts</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Settings Modal -->
    <div class="modal-overlay" id="chatSettingsModal">
        <div class="modal">
            <div class="modal-header">
                <h3>‚öôÔ∏è Chat Settings</h3>
                <button class="modal-close" onclick="closeModal('chatSettingsModal')">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Auto-Delete Settings -->
                <div class="settings-section">
                    <div class="settings-label">
                        <span class="settings-icon">‚è±Ô∏è</span>
                        <div>
                            <div class="settings-title">Auto-Delete Messages</div>
                            <div class="settings-desc">Messages will automatically be deleted after the selected time period</div>
                        </div>
                    </div>
                    <div class="settings-options" id="autoDeleteOptions">
                        <label class="settings-option">
                            <input type="radio" name="auto_delete" value="never" checked>
                            <span class="option-radio"></span>
                            <span class="option-text">Never</span>
                        </label>
                        <label class="settings-option">
                            <input type="radio" name="auto_delete" value="1_day">
                            <span class="option-radio"></span>
                            <span class="option-text">1 Day</span>
                        </label>
                        <label class="settings-option">
                            <input type="radio" name="auto_delete" value="1_week">
                            <span class="option-radio"></span>
                            <span class="option-text">1 Week</span>
                        </label>
                        <label class="settings-option">
                            <input type="radio" name="auto_delete" value="1_month">
                            <span class="option-radio"></span>
                            <span class="option-text">1 Month</span>
                        </label>
                        <label class="settings-option">
                            <input type="radio" name="auto_delete" value="1_year">
                            <span class="option-radio"></span>
                            <span class="option-text">1 Year</span>
                        </label>
                    </div>
                </div>

                <!-- Divider -->
                <div style="border-top: 1px solid var(--border); margin: 1.25rem 0;"></div>

                <!-- Start Fresh / Clear Chat -->
                <div class="settings-section danger-section">
                    <div class="settings-label">
                        <span class="settings-icon">üóëÔ∏è</span>
                        <div>
                            <div class="settings-title">Start Fresh</div>
                            <div class="settings-desc">Clear all messages and start a new conversation. This cannot be undone.</div>
                        </div>
                    </div>
                    <button class="danger-btn" onclick="confirmClearChat()">
                        Clear All Messages
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('chatSettingsModal')">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="saveChatSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Clear Chat Confirmation Modal -->
    <div class="modal-overlay" id="clearChatModal">
        <div class="modal" style="max-width: 360px;">
            <div class="modal-header">
                <h3>‚ö†Ô∏è Clear All Messages?</h3>
                <button class="modal-close" onclick="closeModal('clearChatModal')">√ó</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üóëÔ∏è</div>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                    This will permanently delete all messages in this conversation for <strong>both you and <span id="clearChatFriend"></span></strong>.
                </p>
                <p style="color: #ef4444; font-size: 0.875rem; font-weight: 500;">
                    This action cannot be undone.
                </p>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('clearChatModal')">Cancel</button>
                <button class="modal-btn" style="background: #ef4444; color: white;" onclick="clearChat()">Yes, Clear All</button>
            </div>
        </div>
    </div>

    <!-- Create Shared Note Modal -->
    <div class="modal-overlay" id="createNoteModal">
        <div class="modal" style="max-width: 480px;">
            <div class="modal-header">
                <h3>üìù Create Shared Note</h3>
                <button class="modal-close" onclick="closeModal('createNoteModal')">√ó</button>
            </div>
            <div class="modal-body">
                <p style="font-size: 0.8125rem; color: var(--text-muted); margin-bottom: 1rem;">
                    Create a secure note that both you and <strong id="noteRecipientName"></strong> can access with your own unique secret phrases.
                    Each person sets their own phrase for privacy.
                </p>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.8125rem; font-weight: 600; margin-bottom: 0.5rem;">Note Title</label>
                    <input type="text" class="modal-input" id="noteTitle" placeholder="e.g., Secret Project Details">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.8125rem; font-weight: 600; margin-bottom: 0.5rem;">Note Content</label>
                    <textarea class="modal-input" id="noteContent" placeholder="Enter the sensitive information to share..." rows="4" style="resize: vertical;"></textarea>
                </div>
                <div style="background: rgba(245, 158, 11, 0.08); border: 1px solid rgba(245, 158, 11, 0.2); border-radius: var(--radius-md); padding: 1rem; margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.8125rem; font-weight: 600; margin-bottom: 0.5rem; color: #f59e0b;">üîê Your Secret Phrase</label>
                    <input type="text" class="modal-input" id="creatorPhrase" placeholder="Type a memorable phrase only you know..." style="background: var(--bg-card); border-color: rgba(245, 158, 11, 0.3);">
                    <p style="font-size: 0.6875rem; color: var(--text-muted); margin-top: 0.5rem;">
                        You'll need to type this exact phrase to unlock the note. The other person will set their own phrase.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('createNoteModal')">Cancel</button>
                <button class="modal-btn" style="background: linear-gradient(135deg, #f59e0b, #ef4444); color: white;" onclick="createSharedNote()">Create Note</button>
            </div>
        </div>
    </div>

    <!-- Set Phrase Modal -->
    <div class="modal-overlay" id="setPhraseModal">
        <div class="modal" style="max-width: 420px;">
            <div class="modal-header">
                <h3>üîê Set Your Secret Phrase</h3>
                <button class="modal-close" onclick="closeModal('setPhraseModal')">√ó</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üìù</div>
                <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">
                    <strong id="phraseNoteCreator"></strong> shared a note with you:
                </p>
                <p style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1.5rem; color: #f59e0b;" id="phraseNoteTitle"></p>
                <p style="font-size: 0.8125rem; color: var(--text-muted); margin-bottom: 1rem;">
                    Set your own secret phrase to unlock this note. Only you will know your phrase.
                </p>
                <input type="hidden" id="setPhraseNoteId">
                <input type="text" class="modal-input" id="userPhrase" placeholder="Enter your secret phrase..." style="text-align: center;">
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('setPhraseModal')">Later</button>
                <button class="modal-btn modal-btn-primary" onclick="setNotePhrase()">Set Phrase</button>
            </div>
        </div>
    </div>

    <!-- Unlock Note Modal -->
    <div class="modal-overlay" id="unlockNoteModal">
        <div class="modal" style="max-width: 420px;">
            <div class="modal-header">
                <h3>üîì Unlock Note</h3>
                <button class="modal-close" onclick="closeModal('unlockNoteModal')">√ó</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üîí</div>
                <p style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;" id="unlockNoteTitle"></p>
                <p style="font-size: 0.8125rem; color: var(--text-muted); margin-bottom: 1rem;">
                    Enter your secret phrase to unlock this note.
                </p>
                <input type="hidden" id="unlockNoteId">
                <input type="text" class="modal-input" id="unlockPhrase" placeholder="Type your secret phrase..." style="text-align: center;" onkeydown="if(event.key==='Enter')unlockNote()">
                <p id="unlockError" style="color: #ef4444; font-size: 0.8125rem; margin-top: 0.75rem; display: none;">Incorrect phrase. Try again.</p>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('unlockNoteModal')">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="unlockNote()">Unlock</button>
            </div>
        </div>
    </div>

    <!-- View Unlocked Note Modal -->
    <div class="modal-overlay" id="viewNoteModal">
        <div class="modal" style="max-width: 540px;">
            <div class="modal-header">
                <h3>üìù <span id="viewNoteTitle"></span></h3>
                <button class="modal-close" onclick="closeModal('viewNoteModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.08), rgba(16, 185, 129, 0.03)); border: 1px solid rgba(16, 185, 129, 0.15); border-radius: var(--radius-md); padding: 1.25rem;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--success); font-size: 0.8125rem; font-weight: 600;">
                            <span style="background: rgba(16, 185, 129, 0.15); padding: 0.25rem 0.5rem; border-radius: var(--radius-sm);">üîì Unlocked</span>
                        </div>
                        <span id="viewNoteEditInfo" style="font-size: 0.6875rem; color: var(--text-muted);"></span>
                    </div>
                    <div id="viewNoteContent" style="font-family: 'Space Grotesk', sans-serif; font-size: 0.9375rem; color: var(--text-primary); white-space: pre-wrap; word-wrap: break-word; margin: 0; line-height: 1.7; background: rgba(0,0,0,0.2); padding: 1rem; border-radius: var(--radius-sm); border: 1px solid rgba(255,255,255,0.05);"></div>
                </div>
                <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin: 0;">
                        Created by <strong id="viewNoteCreator"></strong>
                    </p>
                    <input type="hidden" id="viewNoteId">
                </div>
            </div>
            <div class="modal-footer" style="justify-content: space-between;">
                <button class="modal-btn" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05)); border: 1px solid rgba(59, 130, 246, 0.2); color: #3b82f6;" onclick="editFromViewModal()">‚úèÔ∏è Edit Note</button>
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('viewNoteModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Note Modal -->
    <div class="modal-overlay" id="editNoteModal">
        <div class="modal" style="max-width: 520px;">
            <div class="modal-header">
                <h3>‚úèÔ∏è Edit Shared Note</h3>
                <button class="modal-close" onclick="closeModal('editNoteModal')">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editNoteId">
                
                <div style="margin-bottom: 1.25rem;">
                    <label style="display: block; font-size: 0.8125rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-secondary);">Note Title</label>
                    <input type="text" class="modal-input" id="editNoteTitle" placeholder="Note title">
                </div>
                
                <div style="margin-bottom: 1.25rem;">
                    <label style="display: block; font-size: 0.8125rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-secondary);">Note Content</label>
                    <textarea class="modal-input" id="editNoteContent" placeholder="Note content..." rows="5" style="resize: vertical; min-height: 120px;"></textarea>
                </div>
                
                <div style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.08), rgba(168, 85, 247, 0.03)); border: 1px solid rgba(168, 85, 247, 0.15); border-radius: var(--radius-md); padding: 1rem;">
                    <label style="display: block; font-size: 0.8125rem; font-weight: 600; margin-bottom: 0.5rem; color: #a855f7;">üîê Confirm Your Phrase</label>
                    <input type="password" class="modal-input" id="editNotePhrase" placeholder="Enter your secret phrase to save changes..." style="background: var(--bg-card); border-color: rgba(168, 85, 247, 0.25);">
                    <p style="font-size: 0.6875rem; color: var(--text-muted); margin-top: 0.5rem; margin-bottom: 0;">
                        Your phrase is required to authorize changes to this note.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('editNoteModal')">Cancel</button>
                <button class="modal-btn" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white;" onclick="saveNoteEdit()">üíæ Save Changes</button>
            </div>
        </div>
    </div>


    <!-- Call Page (Full Screen Interactive) -->
    <div class="call-page" id="callPage">
        <!-- Call Page Header -->
        <div class="call-page-header">
            <div class="call-page-info">
                <button class="call-back-btn" onclick="minimizeCall()" title="Minimize">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                </button>
                <div class="call-page-title">
                    <h2 id="callPageTitle">Call</h2>
                    <div class="call-page-meta">
                        <span class="call-type-indicator" id="callTypeIndicator">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/>
                            </svg>
                            <span id="callTypeText">Voice Call</span>
                        </span>
                        <span class="call-timer" id="callTimer">
                            <span class="timer-dot"></span>
                            <span id="callDuration">00:00</span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="call-page-actions">
                <span class="participants-count" id="participantsCount">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/>
                    </svg>
                    <span id="participantCountNum">1</span> in call
                </span>
            </div>
        </div>
        
        <!-- Listener Banner (for channel viewers) -->
        <div class="listener-banner" id="listenerBanner" style="display: none;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 18v-6a9 9 0 0118 0v6"/>
                <path d="M21 19a2 2 0 01-2 2h-1a2 2 0 01-2-2v-3a2 2 0 012-2h3zM3 19a2 2 0 002 2h1a2 2 0 002-2v-3a2 2 0 00-2-2H3z"/>
            </svg>
            You're in listener mode. Only admins and moderators can speak in channel calls.
        </div>
        
        <!-- Participants Grid -->
        <div class="participants-grid" id="participantsGrid">
            <!-- Your tile (always shown) -->
            <div class="participant-tile you" id="localParticipantTile">
                <div class="participant-video-container">
                    <video id="localVideo" autoplay muted playsinline></video>
                    <div class="participant-avatar-large" id="localAvatarFallback">
                        <span>{{ username[0].upper() }}</span>
                    </div>
                </div>
                <div class="participant-info-bar">
                    <span class="participant-name-label">You</span>
                    <div class="participant-status-icons" id="localStatusIcons">
                        <!-- Status icons will be added here -->
                    </div>
                </div>
                <div class="speaking-ring"></div>
            </div>
            
            <!-- Remote participants will be added here dynamically -->
        </div>
        
        <!-- Call Controls Bar -->
        <div class="call-controls-bar">
            <div class="controls-group">
                <button class="control-button" id="toggleMicBtn" onclick="toggleMic()" title="Mute/Unmute">
                    <div class="control-icon">
                        <svg class="icon-on" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/>
                            <path d="M19 10v2a7 7 0 01-14 0v-2"/>
                            <line x1="12" y1="19" x2="12" y2="23"/>
                            <line x1="8" y1="23" x2="16" y2="23"/>
                        </svg>
                        <svg class="icon-off" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="1" y1="1" x2="23" y2="23"/>
                            <path d="M9 9v3a3 3 0 005.12 2.12M15 9.34V4a3 3 0 00-5.94-.6"/>
                            <path d="M17 16.95A7 7 0 015 12v-2m14 0v2a7 7 0 01-.11 1.23"/>
                            <line x1="12" y1="19" x2="12" y2="23"/>
                            <line x1="8" y1="23" x2="16" y2="23"/>
                        </svg>
                    </div>
                    <span class="control-label">Mic</span>
                </button>
                
                <button class="control-button" id="toggleVideoBtn" onclick="toggleVideo()" title="Camera On/Off">
                    <div class="control-icon">
                        <svg class="icon-on" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="23 7 16 12 23 17 23 7"/>
                            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                        </svg>
                        <svg class="icon-off" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 16v1a2 2 0 01-2 2H3a2 2 0 01-2-2V7a2 2 0 012-2h2m5.66 0H14a2 2 0 012 2v3.34l1 1L23 7v10"/>
                            <line x1="1" y1="1" x2="23" y2="23"/>
                        </svg>
                    </div>
                    <span class="control-label">Camera</span>
                </button>
                
                <button class="control-button" id="screenShareBtn" onclick="toggleScreenShare()" title="Share Screen">
                    <div class="control-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                            <line x1="8" y1="21" x2="16" y2="21"/>
                            <line x1="12" y1="17" x2="12" y2="21"/>
                        </svg>
                    </div>
                    <span class="control-label">Share</span>
                </button>
            </div>
            
            <button class="end-call-button" onclick="endCall()" title="End Call">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.68 13.31a16 16 0 003.41 2.6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7 2 2 0 011.72 2v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.42 19.42 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91"/>
                    <line x1="23" y1="1" x2="1" y2="23"/>
                </svg>
                <span>End Call</span>
            </button>
        </div>
    </div>
    
    <!-- Incoming Call Modal -->
    <div class="incoming-call-modal" id="incomingCallModal">
        <div class="incoming-call-avatar" id="incomingCallAvatar">?</div>
        <div class="incoming-call-name" id="incomingCallName">Unknown</div>
        <div class="incoming-call-type" id="incomingCallType">Voice Call</div>
        <div class="incoming-call-actions">
            <button class="incoming-call-btn decline" onclick="declineIncomingCall()" title="Decline">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.68 13.31a16 16 0 003.41 2.6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7 2 2 0 011.72 2v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.42 19.42 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91"/>
                    <line x1="23" y1="1" x2="1" y2="23"/>
                </svg>
            </button>
            <button class="incoming-call-btn accept" onclick="acceptIncomingCall()" title="Accept">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/>
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Active Call Indicator (mini bar) -->
    <div class="active-call-indicator" id="activeCallIndicator" onclick="returnToCall()">
        <div class="pulse-dot"></div>
        <span>In Call</span>
        <span id="miniCallDuration">00:00</span>
    </div>

    <!-- Pass data from server to JavaScript -->
    <script>
        window.MENZA_USERNAME = "{{ username }}";
    </script>
    <script src="/static/js/chat.js"></script>
</body>
</html>
